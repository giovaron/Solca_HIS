-- Se ejecuta cuando se modifica el estado de la contabilización del cierre
BEGIN
DECLARE  
   ERRORES_CONTABILIZA EXCEPTION;
   PRAGMA EXCEPTION_INIT(ERRORES_CONTABILIZA,-20200);  
BEGIN
   IF :CNTCRRMES.CNTCRRMES = 'C' THEN
   BEGIN
      CNTINT2.CONTABILIZAR_GASTOS_INV(:CNTCRRMES.CNTCRRMES_ID,:TOTEGR.TOTAL_EGRESOS,:GLOBAL.TIPO_DE_CAMBIO,
      :GLOBAL.TIPO_DE_CAMBIOE,:GLOBAL.MONEDA_LOCAL,:GLOBAL.CG$EMPRESA_CODIGO,:CNTCRRMES.TPOCMP_CODIGO,
      :CNTCRRMES.CMP_FECHA,:CNTCRRMES.CMP_CLAVE); 
      UPDATE CONTABILIZACION_CIERRE_MES
      SET CMP_CLAVE = :CNTCRRMES.CMP_CLAVE
      WHERE EMP_CODIGO = :GLOBAL.CG$EMPRESA_CODIGO AND
            CNTCRRMES_ID = :CNTCRRMES.CNTCRRMES_ID;
   EXCEPTION 
      WHEN ERRORES_CONTABILIZA THEN
         :CNTCRRMES.CNTCRRMES:='V';
      WHEN OTHERS THEN
         :CNTCRRMES.CNTCRRMES:='E';
         QMS$ERRORS.UNHANDLED_EXCEPTION ('Fallo la contabilización por error ' || SQLERRM);     
   END;
   END IF;
END;
END;
