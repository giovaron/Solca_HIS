PROMPT Altering Table 'RETENCIONES' 
ALTER TABLE RETENCIONES 
 ADD (AUTORIZACION_SRI VARCHAR2(10)
 ,SERIE_SRI VARCHAR2(6)
 ,SECUENCIA_SRI NUMBER(7)
 )
/

COMMENT ON COLUMN RETENCIONES.AUTORIZACION_SRI IS 'La autorizacion Sri para la Retencion'
/

COMMENT ON COLUMN RETENCIONES.SERIE_SRI IS 'El numero de Serie para la retencion'
/

COMMENT ON COLUMN RETENCIONES.SECUENCIA_SRI IS 'La secuencia para la retencion'
/




CREATE OR REPLACE FORCE VIEW DETALLES_REOC_SRI
 (EMP_CODIGO
 ,CMP_TIPO
 ,CMP_CLAVE
 ,FECHA
 ,IDENTIFICACION
 ,RETENIDO_A
 ,IVA
 ,TOTAL_FACTURADO
 ,TOTAL_OTROS
 ,TOTAL_RETENIDO
 ,CODIGO
 ,PORCENTAJE
 ,SERIE_RF
 ,SECUENCIA_RF
 ,AUTORIZACION_RF)
 AS SELECT RTN.TPORTNEMP_EMP_CODIGO CMP_CODIGO,RTN.TPOCMPEMP_TPOCMP_CODIGO CMP_TIPO,
    RTN.CMP_CLAVE CMP_CLAVE,RTN.CMP_FECHA FECHA,RUC,RETENIDO_A,TPORTN.FORMULA_IVA IVA, DECODE(CR.ID_RETENCION_FUENTE,'322', TOTAL_FACTURADO/10,TOTAL_FACTURADO) TOTAL_FACTURADO,TO_NUMBER(CR.TOTAL_OTROS),TOTAL_RETENIDO,
    CR.ID_RETENCION_FUENTE CODIGO,
DECODE(CR.ID_RETENCION_FUENTE,'322',TPORTN.VALOR*10,TPORTN.VALOR) PORCENTAJE,
SERIE_SRI SERIE_RF,TO_CHAR(SECUENCIA_SRI,'9999999') SECUENCIA_RF, AUTORIZACION_SRI AUTORIZACION_RF
FROM RETENCIONES RTN,COMPROBANTES_POR_REVISAR CR,TIPOS_DE_RETENCIONES TPORTN
WHERE RTN.ESTADO!='A'
AND CR.TPOCMPEMP_EMP_CODIGO=RTN.TPORTNEMP_EMP_CODIGO
AND CR.TPOCMPEMP_TPOCMP_CODIGO=RTN.TPOCMPEMP_TPOCMP_CODIGO
AND CR.FECHA=RTN.CMP_FECHA
AND CR.CLAVE=RTN.CMP_CLAVE
AND RTN.TPORTNEMP_TPORTN_CODIGO=TPORTN.CODIGO
UNION ALL
SELECT CR.TPOCMPEMP_EMP_CODIGO EMP_CODIGO,
       CR.TPOCMPEMP_TPOCMP_CODIGO CMP_TIPO,
       CR.CLAVE CMP_CLAVE,
       CR.FECHA FECHA,
       CR.RUC_CED_PSP RUC,
       CR.BENEFICIARIO RETENIDO_A,
       '0' FORMULA_IVA,
       TO_NUMBER(CR.SUBTOTAL) +TO_NUMBER(CR.SUBTOTAL_HONORARIOS) TOTAL_FACTURADO,
       TO_NUMBER(TOTAL_OTROS) TOTAL_OTROS,
       0,CR.ID_RETENCION_FUENTE,0 PORCENTAJE,'' SERIE_RF,'' SECUENCIA_RF,'' AUTORIZACION_RF
FROM COMPROBANTES_POR_REVISAR CR 
WHERE (CR.ID_RETENCION_FUENTE = '332' OR
      CR.ID_RETENCION_FUENTE = '308') AND
      CR.ESTADO != 'A'
UNION ALL
SELECT RTN.TPORTNEMP_EMP_CODIGO CMP_CODIGO,RTN.TPOCMPEMP_TPOCMP_CODIGO CMP_TIPO,
    RTN.CMP_CLAVE CMP_CLAVE,RTN.CMP_FECHA FECHA,RUC,RETENIDO_A,
    TPORTN.FORMULA_IVA IVA,TOTAL_FACTURADO,0,TOTAL_RETENIDO,ASCCMP.DOCUMENTO CODIGO,
    TPORTN.VALOR,'' SERIE_RF,'' SECUENCIA_RF,'' AUTORIZACION_RF
FROM RETENCIONES RTN,ASOCIACIONES_COMPROBANTE ASCCMP,TIPOS_DE_RETENCIONES TPORTN,
TIPOS_DE_COMPROBANTES TPOCMP
WHERE RTN.ESTADO!='A'
AND ASCCMP.CMP_TPOCMPEMP_EMP_CODIGO=RTN.TPORTNEMP_EMP_CODIGO
AND ASCCMP.ASCTPOCMP_TPOCMP_CODIGO=RTN.TPOCMPEMP_TPOCMP_CODIGO
AND ASCCMP.CMP_FECHA=RTN.CMP_FECHA
AND ASCCMP.CMP_CLAVE=RTN.CMP_CLAVE
AND ASCCMP.ASCTPOCMP_NOMBRE= 'ID RETENCION FUENTE'
AND TPOCMP.CODIGO=ASCCMP.ASCTPOCMP_TPOCMP_CODIGO
AND TPOCMP.RETENCIONES='R'
AND RTN.TPORTNEMP_TPORTN_CODIGO=TPORTN.CODIGO
/




CREATE OR REPLACE VIEW "COMPROBANTES_POR_REVISAR" 
    ("TPOCMPEMP_EMP_CODIGO","TPOCMPEMP_TPOCMP_CODIGO","FECHA",
    "CLAVE","CONCEPTO","REVISADO","MAYORIZADO","ESTADO",
    "BENEFICIARIO","RUC_CED_PSP","FECHA_EMISION",
    "SERIE_COMPROBANTE","FACTURA_NO_COMP","SUBTOTAL",
    "SUBTOTAL_HONORARIOS","TOTAL_OTROS","ID_RETENCION_FUENTE",
    "NO_AUTORIZACION","TIPO_COMPROBANTE") AS 
    SELECT /* COMPROBANTES TL*/ 
DISTINCT TPOCMPEMP_EMP_CODIGO, 
TPOCMPEMP_TPOCMP_CODIGO,FECHA,CLAVE, 
CONCEPTO, 
REVISADO, 
MAYORIZADO, 
ESTADO, 
ASCCMP1.DOCUMENTO "BENEFICIARIO", 
ASCCMP2.DOCUMENTO "RUC/CED/PSP", 
ASCCMP3.DOCUMENTO "FECHA EMISION", 
ASCCMP4.DOCUMENTO "SERIE COMPROBANTE", 
ASCCMP5.DOCUMENTO "FACTURA/NO COMP.", 
ASCCMP6.DOCUMENTO "SUBTOTAL", 
ASCCMP7.DOCUMENTO "SUBTOTAL HONORARIOS",  
ASCCMP8.DOCUMENTO "TOTAL OTROS", 
ASCCMP9.DOCUMENTO "ID RETENCION FUENTE", 
ASCCMP0.DOCUMENTO "NO. AUTORIZACION", 
ASCCMPA.DOCUMENTO "TIPO COMPROBANTE" 
FROM COMPROBANTES CMP, 
ASOCIACIONES_COMPROBANTE ASCCMP1,  
ASOCIACIONES_COMPROBANTE ASCCMP2, 
ASOCIACIONES_COMPROBANTE ASCCMP3, 
ASOCIACIONES_COMPROBANTE ASCCMP4, 
ASOCIACIONES_COMPROBANTE ASCCMP5, 
ASOCIACIONES_COMPROBANTE ASCCMP6, 
ASOCIACIONES_COMPROBANTE ASCCMP7, 
ASOCIACIONES_COMPROBANTE ASCCMP8, 
ASOCIACIONES_COMPROBANTE ASCCMP9, 
ASOCIACIONES_COMPROBANTE ASCCMP0, 
ASOCIACIONES_COMPROBANTE ASCCMPA 
WHERE  
ASCCMP1.CMP_TPOCMPEMP_EMP_CODIGO=TPOCMPEMP_EMP_CODIGO AND 
ASCCMP1.ASCTPOCMP_TPOCMP_CODIGO=TPOCMPEMP_TPOCMP_CODIGO AND 
ASCCMP1.CMP_FECHA=FECHA AND                       
ASCCMP1.CMP_CLAVE=CLAVE AND 
ASCCMP1.ASCTPOCMP_NOMBRE='BENEFICIARIO' AND 
ASCCMP2.CMP_TPOCMPEMP_EMP_CODIGO=TPOCMPEMP_EMP_CODIGO AND 
ASCCMP2.ASCTPOCMP_TPOCMP_CODIGO=TPOCMPEMP_TPOCMP_CODIGO AND 
ASCCMP2.CMP_FECHA=FECHA AND                       
ASCCMP2.CMP_CLAVE=CLAVE AND 
ASCCMP2.ASCTPOCMP_NOMBRE='RUC/CED/PSP' AND 
ASCCMP3.CMP_TPOCMPEMP_EMP_CODIGO=TPOCMPEMP_EMP_CODIGO AND 
ASCCMP3.ASCTPOCMP_TPOCMP_CODIGO=TPOCMPEMP_TPOCMP_CODIGO AND 
ASCCMP3.CMP_FECHA=FECHA AND                       
ASCCMP3.CMP_CLAVE=CLAVE AND 
ASCCMP3.ASCTPOCMP_NOMBRE='FECHA EMISION' AND 
ASCCMP4.CMP_TPOCMPEMP_EMP_CODIGO=TPOCMPEMP_EMP_CODIGO AND 
ASCCMP4.ASCTPOCMP_TPOCMP_CODIGO=TPOCMPEMP_TPOCMP_CODIGO AND 
ASCCMP4.CMP_FECHA=FECHA AND                       
ASCCMP4.CMP_CLAVE=CLAVE AND 
ASCCMP4.ASCTPOCMP_NOMBRE='SERIE COMPROBANTE' AND 
ASCCMP5.CMP_TPOCMPEMP_EMP_CODIGO=TPOCMPEMP_EMP_CODIGO AND 
ASCCMP5.ASCTPOCMP_TPOCMP_CODIGO=TPOCMPEMP_TPOCMP_CODIGO AND 
ASCCMP5.CMP_FECHA=FECHA AND                       
ASCCMP5.CMP_CLAVE=CLAVE AND 
ASCCMP5.ASCTPOCMP_NOMBRE='FACTURA/NO COMP.' AND 
ASCCMP6.CMP_TPOCMPEMP_EMP_CODIGO=TPOCMPEMP_EMP_CODIGO AND 
ASCCMP6.ASCTPOCMP_TPOCMP_CODIGO=TPOCMPEMP_TPOCMP_CODIGO AND 
ASCCMP6.CMP_FECHA=FECHA AND                       
ASCCMP6.CMP_CLAVE=CLAVE AND 
ASCCMP6.ASCTPOCMP_NOMBRE='SUBTOTAL' AND  
ASCCMP7.CMP_TPOCMPEMP_EMP_CODIGO=TPOCMPEMP_EMP_CODIGO AND 
ASCCMP7.ASCTPOCMP_TPOCMP_CODIGO=TPOCMPEMP_TPOCMP_CODIGO AND 
ASCCMP7.CMP_FECHA=FECHA AND                       
ASCCMP7.CMP_CLAVE=CLAVE AND 
ASCCMP7.ASCTPOCMP_NOMBRE='SUBTOTAL HONORARIOS' AND 
ASCCMP8.CMP_TPOCMPEMP_EMP_CODIGO=TPOCMPEMP_EMP_CODIGO AND 
ASCCMP8.ASCTPOCMP_TPOCMP_CODIGO=TPOCMPEMP_TPOCMP_CODIGO AND 
ASCCMP8.CMP_FECHA=FECHA AND                       
ASCCMP8.CMP_CLAVE=CLAVE AND 
ASCCMP8.ASCTPOCMP_NOMBRE='TOTAL OTROS' AND 
ASCCMP9.CMP_TPOCMPEMP_EMP_CODIGO=TPOCMPEMP_EMP_CODIGO AND 
ASCCMP9.ASCTPOCMP_TPOCMP_CODIGO=TPOCMPEMP_TPOCMP_CODIGO AND 
ASCCMP9.CMP_FECHA=FECHA AND                       
ASCCMP9.CMP_CLAVE=CLAVE AND 
ASCCMP9.ASCTPOCMP_NOMBRE='ID RETENCION FUENTE' AND 
ASCCMP0.CMP_TPOCMPEMP_EMP_CODIGO=TPOCMPEMP_EMP_CODIGO AND 
ASCCMP0.ASCTPOCMP_TPOCMP_CODIGO=TPOCMPEMP_TPOCMP_CODIGO AND 
ASCCMP0.CMP_FECHA=FECHA AND                       
ASCCMP0.CMP_CLAVE=CLAVE AND 
ASCCMP0.ASCTPOCMP_NOMBRE='NO. AUTORIZACION' AND 
ASCCMPA.CMP_TPOCMPEMP_EMP_CODIGO=TPOCMPEMP_EMP_CODIGO AND 
ASCCMPA.ASCTPOCMP_TPOCMP_CODIGO=TPOCMPEMP_TPOCMP_CODIGO AND 
ASCCMPA.CMP_FECHA=FECHA AND                       
ASCCMPA.CMP_CLAVE=CLAVE AND 
ASCCMPA.ASCTPOCMP_NOMBRE='TIPO COMPROBANTE' 
UNION ALL 
/* COMPROBANTES NC/ND*/ 
SELECT 
DISTINCT TPOCMPEMP_EMP_CODIGO, 
TPOCMPEMP_TPOCMP_CODIGO,FECHA,CLAVE, 
CONCEPTO, 
REVISADO, 
MAYORIZADO, 
ESTADO, 
ASCCMP1.DOCUMENTO "BENEFICIARIO", 
ASCCMP2.DOCUMENTO "RUC/CED/PSP", 
ASCCMP3.DOCUMENTO "FECHA EMISION", 
ASCCMP4.DOCUMENTO "SERIE COMPROBANTE", 
ASCCMP5.DOCUMENTO "FACTURA/NO COMP.",'0','0','0','-1', 
ASCCMP0.DOCUMENTO "NO. AUTORIZACION",'-1' 
FROM COMPROBANTES CMP, 
ASOCIACIONES_COMPROBANTE ASCCMP1, 
ASOCIACIONES_COMPROBANTE ASCCMP2, 
ASOCIACIONES_COMPROBANTE ASCCMP3, 
ASOCIACIONES_COMPROBANTE ASCCMP4, 
ASOCIACIONES_COMPROBANTE ASCCMP5, 
ASOCIACIONES_COMPROBANTE ASCCMP0 
WHERE 
ASCCMP1.CMP_TPOCMPEMP_EMP_CODIGO=TPOCMPEMP_EMP_CODIGO AND 
ASCCMP1.ASCTPOCMP_TPOCMP_CODIGO=TPOCMPEMP_TPOCMP_CODIGO AND 
ASCCMP1.CMP_FECHA=FECHA AND 
ASCCMP1.CMP_CLAVE=CLAVE AND 
ASCCMP1.ASCTPOCMP_NOMBRE='BENEFICIARIO'  AND 
ASCCMP2.CMP_TPOCMPEMP_EMP_CODIGO=TPOCMPEMP_EMP_CODIGO AND 
ASCCMP2.ASCTPOCMP_TPOCMP_CODIGO=TPOCMPEMP_TPOCMP_CODIGO AND 
ASCCMP2.CMP_FECHA=FECHA AND 
ASCCMP2.CMP_CLAVE=CLAVE AND 
ASCCMP2.ASCTPOCMP_NOMBRE='RUC/CED/PSP' AND 
ASCCMP3.CMP_TPOCMPEMP_EMP_CODIGO=TPOCMPEMP_EMP_CODIGO AND 
ASCCMP3.ASCTPOCMP_TPOCMP_CODIGO=TPOCMPEMP_TPOCMP_CODIGO AND 
ASCCMP3.CMP_FECHA=FECHA AND 
ASCCMP3.CMP_CLAVE=CLAVE AND 
ASCCMP3.ASCTPOCMP_NOMBRE='FECHA EMISION NOTA' AND 
ASCCMP4.CMP_TPOCMPEMP_EMP_CODIGO=TPOCMPEMP_EMP_CODIGO AND 
ASCCMP4.ASCTPOCMP_TPOCMP_CODIGO=TPOCMPEMP_TPOCMP_CODIGO AND 
ASCCMP4.CMP_FECHA=FECHA AND 
ASCCMP4.CMP_CLAVE=CLAVE AND 
ASCCMP4.ASCTPOCMP_NOMBRE='SERIE NOTA' AND 
ASCCMP5.CMP_TPOCMPEMP_EMP_CODIGO=TPOCMPEMP_EMP_CODIGO AND 
ASCCMP5.ASCTPOCMP_TPOCMP_CODIGO=TPOCMPEMP_TPOCMP_CODIGO AND 
ASCCMP5.CMP_FECHA=FECHA AND 
ASCCMP5.CMP_CLAVE=CLAVE AND 
ASCCMP5.ASCTPOCMP_NOMBRE='NO. NOTA' AND 
ASCCMP0.CMP_TPOCMPEMP_EMP_CODIGO=TPOCMPEMP_EMP_CODIGO AND 
ASCCMP0.ASCTPOCMP_TPOCMP_CODIGO=TPOCMPEMP_TPOCMP_CODIGO AND 
ASCCMP0.CMP_FECHA=FECHA AND 
ASCCMP0.CMP_CLAVE=CLAVE AND 
ASCCMP0.ASCTPOCMP_NOMBRE='NO. AUTORIZACION'