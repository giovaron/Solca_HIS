DECLARE
-- SE CORRIJE EL VALOR DEL IECE Y DEL SECAP QUE NO INCLUYO EL SOBRESUELDO
nNumRol NUMBER:=21;
CURSOR cCorreccion IS
  SELECT ROLPGS_EMP_CODIGO,ROLPGS_NUMERO,EMPROL_CODIGO,VALOR
  FROM MOVIMIENTOS_ROLES
  WHERE PRMROL_CODIGO='P0137' --SOBRESUELDOS
  AND ESTADO='N'
  AND ROLPGS_EMP_CODIGO='CSI'
  AND ROLPGS_NUMERO=nNumRol;
BEGIN
  FOR rCorreccion in cCorreccion LOOP
--    DBMS_OUTPUT.PUT_LINE('Corrigiendo el empleado '||rCorreccion.EMPROL_CODIGO);
    UPDATE MOVIMIENTOS_ROLES
    SET debe=debe+rCorreccion.valor*.005,valor=valor+rCorreccion.valor*.005
    WHERE ROLPGS_NUMERO=rCorreccion.ROLPGS_NUMERO AND
          ROLPGS_EMP_CODIGO=rCorreccion.ROLPGS_EMP_CODIGO AND
          EMPROL_EMP_CODIGO=rCorreccion.ROLPGS_EMP_CODIGO AND
          EMPROL_CODIGO=rCorreccion.EMPROL_CODIGO AND
          ESTADO='N' AND PRMROL_CODIGO='P0071'; -- IECE
    IF sql%rowcount!=1 THEN
      DBMS_OUTPUT.PUT_LINE('Error IECE en el empleado '||rCorreccion.EMPROL_CODIGO);
      RAISE DUP_VAL_ON_INDEX;
    END IF;
    UPDATE MOVIMIENTOS_ROLES
    SET debe=debe+rCorreccion.valor*.005,valor=valor+rCorreccion.valor*.005
    WHERE ROLPGS_NUMERO=rCorreccion.ROLPGS_NUMERO AND
          ROLPGS_EMP_CODIGO=rCorreccion.ROLPGS_EMP_CODIGO AND
          EMPROL_EMP_CODIGO=rCorreccion.ROLPGS_EMP_CODIGO AND
          EMPROL_CODIGO=rCorreccion.EMPROL_CODIGO AND
          ESTADO='N' AND PRMROL_CODIGO='P0072'; -- SECAP
    IF sql%rowcount!=1 THEN
      DBMS_OUTPUT.PUT_LINE('Error SECAP en el empleado '||rCorreccion.EMPROL_CODIGO);
      RAISE DUP_VAL_ON_INDEX;
    END IF;
  END LOOP;
END;
/
