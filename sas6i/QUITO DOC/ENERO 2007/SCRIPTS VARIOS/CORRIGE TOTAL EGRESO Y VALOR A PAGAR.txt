DECLARE
-- SE CORRIJE EL VALOR DEL TOTAL EGRESOS Y VALOR A PAGAR
nNumRol NUMBER:=27; -- ABRIL
CURSOR cCorreccion IS
  SELECT 'CSI' ROLPGS_EMP_CODIGO,nNumRol ROLPGS_NUMERO,CODIGO EMPROL_CODIGO,VALOR
  FROM CORRECCION_RDP;
BEGIN
  FOR rCorreccion in cCorreccion LOOP
--    DBMS_OUTPUT.PUT_LINE('Corrigiendo el empleado '||rCorreccion.EMPROL_CODIGO);
    UPDATE MOVIMIENTOS_ROLES
    SET valor=valor-rCorreccion.valor
          WHERE ROLPGS_NUMERO=rCorreccion.ROLPGS_NUMERO AND
          ROLPGS_EMP_CODIGO=rCorreccion.ROLPGS_EMP_CODIGO AND
          EMPROL_EMP_CODIGO=rCorreccion.ROLPGS_EMP_CODIGO AND
          EMPROL_CODIGO=rCorreccion.EMPROL_CODIGO AND
          ESTADO='N' AND PRMROL_CODIGO='P0062'; -- VALOR A PAGAR
    IF sql%rowcount!=1 THEN
      DBMS_OUTPUT.PUT_LINE('Error IECE en el empleado '||rCorreccion.EMPROL_CODIGO);
      RAISE DUP_VAL_ON_INDEX;
    END IF;
    UPDATE MOVIMIENTOS_ROLES
    SET valor=valor+rCorreccion.valor
    WHERE ROLPGS_NUMERO=rCorreccion.ROLPGS_NUMERO AND
          ROLPGS_EMP_CODIGO=rCorreccion.ROLPGS_EMP_CODIGO AND
          EMPROL_EMP_CODIGO=rCorreccion.ROLPGS_EMP_CODIGO AND
          EMPROL_CODIGO=rCorreccion.EMPROL_CODIGO AND
          ESTADO='N' AND PRMROL_CODIGO='P0061'; -- TOTAL EGRESOS
    IF sql%rowcount!=1 THEN
      DBMS_OUTPUT.PUT_LINE('Error SECAP en el empleado '||rCorreccion.EMPROL_CODIGO);
      RAISE DUP_VAL_ON_INDEX;
    END IF;
  END LOOP;
END;
/
